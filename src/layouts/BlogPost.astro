---
import { Image } from 'astro:assets';
import type { CollectionEntry, MarkdownHeading } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';

type Props = CollectionEntry<'blog'>['data'] & {
	headings?: MarkdownHeading[];
};

const { title, description, heroImage, headings = [] } = Astro.props;
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} image={heroImage} />
		<style>
			html,
			body {
				max-width: 100%;
				overflow-x: hidden;
				position: relative;
				width: 100%;
			}
			
			main {
				width: calc(100% - 2em);
				max-width: 100%;
				margin: 0;
				padding-top: 0;
				box-sizing: border-box;
				overflow-x: hidden;
			}
			.hero-image {
				width: 100%;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				max-width: 100%;
				height: auto;
			}
			.article-container {
				display: flex;
				max-width: 1200px;
				margin: 0 auto;
				gap: 2rem;
				align-items: flex-start;
				width: 100%;
				box-sizing: border-box;
				overflow-x: hidden;
			}
			.prose {
				flex: 1;
				width: 680px;
				max-width: 100%;
				margin: 0 auto;
				padding: 1em;
				/* 字体、字号、行高、颜色等排版样式已在 global.css 中定义 */
			}
			
			@media (max-width: 768px) {
				.prose {
					padding-left: 1rem;
					padding-right: 1rem;
				}
			}
			.toc {
				position: sticky;
				top: 2rem;
				width: 200px;
				max-height: calc(100vh - 4rem);
				overflow-y: auto;
				padding: 1rem 0;
				font-size: 0.875rem;
				line-height: 1.6;
			}
			.toc-title {
				font-size: 0.75rem;
				font-weight: 600;
				color: #888;
				text-transform: uppercase;
				letter-spacing: 0.05em;
				margin-bottom: 0.75rem;
				transition: color 0.2s ease;
			}
			
			html.dark .toc-title {
				color: #aaaaaa;
			}
			.toc-list {
				list-style: none;
				padding: 0;
				margin: 0;
			}
			.toc-item {
				margin-bottom: 0.5rem;
			}
			.toc-link {
				color: #888;
				text-decoration: none;
				display: block;
				transition: color 0.2s;
			}
			
			html.dark .toc-link {
				color: #aaaaaa;
			}
			
			.toc-link:hover {
				color: var(--text-color);
			}
			
			.toc-link.active {
				color: var(--text-color);
				font-weight: 500;
			}
			.toc-item-h3 {
				padding-left: 1rem;
			}
			.prose :global(h2),
			.prose :global(h3) {
				scroll-margin-top: 2rem;
			}
			@media (max-width: 1024px) {
				.toc {
					display: none;
				}
				.article-container {
					flex-direction: column;
					padding: 0 1rem;
					width: 100%;
					box-sizing: border-box;
					overflow-x: hidden;
				}
				.prose {
					width: 100%;
					max-width: 100%;
					padding-left: 1rem;
					padding-right: 1rem;
				}
			}
			
			/* 回到顶部按钮 */
			.back-to-top {
				position: fixed;
				bottom: 2rem;
				right: 1.5rem;
				width: 48px;
				height: 48px;
				border-radius: 50%;
				background-color: #6366f1;
				color: #ffffff;
				border: none;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
				opacity: 0;
				pointer-events: none;
				transition: opacity 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
				z-index: 40;
			}
			
			.back-to-top.visible {
				opacity: 1;
				pointer-events: auto;
			}
			
			.back-to-top:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
			}
			
			.back-to-top:active {
				transform: translateY(0);
			}
			
			.back-to-top-icon {
				width: 24px;
				height: 24px;
			}
			
			@media (max-width: 768px) {
				.back-to-top {
					bottom: 1.5rem;
					right: 1rem;
					width: 44px;
					height: 44px;
				}
				
				.back-to-top-icon {
					width: 20px;
					height: 20px;
				}
			}
			
			/* 水印容器：固定定位，占满全屏，不挡鼠标事件 */
			.fixed-watermark-container {
				position: fixed !important;
				top: 0 !important;
				left: 0 !important;
				width: 100vw !important;
				height: 100vh !important;
				pointer-events: none !important; /* 关键：让鼠标穿透 */
				z-index: 99999 !important; /* 关键：层级最高 */
				overflow: hidden !important;
			}
			
			/* 水印公共样式 */
			.watermark {
				position: absolute !important;
				font-family: sans-serif !important;
				font-weight: bold !important;
				color: rgba(0, 0, 0, 0.08) !important; /* 深色半透明 */
				user-select: none !important; /* 不可选中 */
				white-space: nowrap !important;
			}
			
			/* 三个水印的具体位置和旋转 */
			.watermark-top-right {
				top: 15% !important;
				right: 10% !important;
				transform: rotate(-15deg) !important;
				font-size: 1.2rem !important;
			}
			
			.watermark-center {
				top: 50% !important;
				left: 50% !important;
				transform: translate(-50%, -50%) rotate(-30deg) !important;
				font-size: 1.5rem !important; /* 中间的稍微大一点 */
			}
			
			.watermark-bottom-left {
				bottom: 15% !important;
				left: 10% !important;
				transform: rotate(-15deg) !important;
				font-size: 1.2rem !important;
			}
			
			/* 深色模式适配 */
			html.dark .watermark {
				color: rgba(255, 255, 255, 0.08) !important;
			}
			
			/* 内联复制代码样式 */
			.copy-code-inline {
				display: inline-block;
				background-color: #f3f4f6;
				padding: 4px 8px;
				border-radius: 4px;
				font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Courier New', monospace;
				font-weight: 600;
				font-size: 0.9em;
				color: #1f2937;
				cursor: pointer;
				user-select: all;
				-webkit-user-select: all;
				transition: background-color 0.2s ease, color 0.2s ease;
				position: relative;
			}
			
			.copy-code-inline:hover {
				background-color: #e5e7eb;
			}
			
			html.dark .copy-code-inline {
				background-color: rgba(255, 255, 255, 0.1);
				color: #e5e7eb;
			}
			
			html.dark .copy-code-inline:hover {
				background-color: rgba(255, 255, 255, 0.15);
			}
			
			.copy-code-inline.copied {
				background-color: rgba(16, 185, 129, 0.15);
				color: #10b981;
			}
			
			html.dark .copy-code-inline.copied {
				background-color: rgba(52, 211, 153, 0.2);
				color: #34d399;
			}
			
			/* 复制提示文字 */
			.copy-hint {
				font-size: 0.85em;
				color: #6b7280;
				margin-left: 6px;
				font-style: italic;
				cursor: pointer;
				transition: color 0.2s ease;
			}
			
			.copy-hint:hover {
				color: #374151;
			}
			
			html.dark .copy-hint {
				color: #9ca3af;
			}
			
			html.dark .copy-hint:hover {
				color: #d1d5db;
			}
			
			.copy-hint.copied-hint {
				color: #10b981;
			}
			
			html.dark .copy-hint.copied-hint {
				color: #34d399;
			}
			
			/* 外部链接样式 */
			.external-link {
				color: #2563eb;
				text-decoration: underline;
				text-decoration-color: rgba(37, 99, 235, 0.3);
				text-underline-offset: 2px;
				transition: text-decoration-color 0.2s ease, color 0.2s ease;
				cursor: pointer;
			}
			
			.external-link:hover {
				color: #1d4ed8;
				text-decoration-color: #2563eb;
			}
			
			html.dark .external-link {
				color: #60a5fa;
				text-decoration-color: rgba(96, 165, 250, 0.3);
			}
			
			html.dark .external-link:hover {
				color: #93c5fd;
				text-decoration-color: #60a5fa;
			}
		</style>
	</head>

	<body>
		<!-- 水印容器 -->
		<div class="fixed-watermark-container">
			<div class="watermark watermark-top-right">12580123.com</div>
			<div class="watermark watermark-center">12580123.com</div>
			<div class="watermark watermark-bottom-left">12580123.com</div>
		</div>
		
		<Header />
		<main>
			<article>
				<div class="hero-image">
					{heroImage && <Image width={1020} height={510} src={heroImage} alt="" />}
				</div>
				<div class="article-container">
					<div class="prose">
						<slot />
					</div>
					{headings.length > 0 && (
						<nav class="toc" id="toc">
							<div class="toc-title">目录</div>
							<ul class="toc-list">
								{headings.map((heading) => {
									// 使用 heading.slug（如果存在），否则生成一个
									const slug = heading.slug || heading.text.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').trim();
									return (
										<li class={`toc-item ${heading.depth === 3 ? 'toc-item-h3' : ''}`}>
											<a href={`#${slug}`} class="toc-link" data-slug={slug}>
												{heading.text}
											</a>
										</li>
									);
								})}
							</ul>
						</nav>
					)}
				</div>
			</article>
		</main>
		<Footer />
		<button id="back-to-top" class="back-to-top" aria-label="Back to top">
			<svg class="back-to-top-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="m18 15-6-6-6 6"></path>
			</svg>
		</button>
		<script>
			// 生成 slug（与 Astro 默认行为一致）
			function generateSlug(text) {
				return text
					.toLowerCase()
					.replace(/[^\w\s-]/g, '')
					.replace(/\s+/g, '-')
					.replace(/-+/g, '-')
					.trim();
			}

			// 为标题添加 ID（如果还没有）
			document.addEventListener('DOMContentLoaded', () => {
				// 内联复制代码功能
				const copyCodeElements = document.querySelectorAll('.copy-code-inline, .copy-hint');
				copyCodeElements.forEach((element) => {
					element.addEventListener('click', async () => {
						const code = element.getAttribute('data-code');
						if (!code) return;
						
						// 找到对应的推荐码元素和提示元素
						const codeElement = element.classList.contains('copy-code-inline') 
							? element 
							: element.previousElementSibling;
						const hintElement = element.classList.contains('copy-hint')
							? element
							: element.nextElementSibling;
						
						try {
							await navigator.clipboard.writeText(code);
							
							// 更新推荐码样式
							if (codeElement && codeElement.classList.contains('copy-code-inline')) {
								codeElement.classList.add('copied');
								const originalCodeText = codeElement.textContent.replace(' ✓', '');
								codeElement.textContent = originalCodeText + ' ✓';
								
								// 1.5秒后恢复
								setTimeout(() => {
									codeElement.classList.remove('copied');
									codeElement.textContent = originalCodeText;
								}, 1500);
							}
							
							// 更新提示文字样式
							if (hintElement && hintElement.classList.contains('copy-hint')) {
								hintElement.classList.add('copied-hint');
								const originalHintText = hintElement.textContent.replace(' ✓', '');
								hintElement.textContent = originalHintText + ' ✓';
								
								setTimeout(() => {
									hintElement.classList.remove('copied-hint');
									hintElement.textContent = originalHintText;
								}, 1500);
							}
						} catch (err) {
							console.error('复制失败:', err);
							// 降级方案
							const textArea = document.createElement('textarea');
							textArea.value = code;
							textArea.style.position = 'fixed';
							textArea.style.opacity = '0';
							document.body.appendChild(textArea);
							textArea.select();
							
							try {
								document.execCommand('copy');
								
								if (codeElement && codeElement.classList.contains('copy-code-inline')) {
									codeElement.classList.add('copied');
									const originalCodeText = codeElement.textContent.replace(' ✓', '');
									codeElement.textContent = originalCodeText + ' ✓';
									
									setTimeout(() => {
										codeElement.classList.remove('copied');
										codeElement.textContent = originalCodeText;
									}, 1500);
								}
								
								if (hintElement && hintElement.classList.contains('copy-hint')) {
									hintElement.classList.add('copied-hint');
									const originalHintText = hintElement.textContent.replace(' ✓', '');
									hintElement.textContent = originalHintText + ' ✓';
									
									setTimeout(() => {
										hintElement.classList.remove('copied-hint');
										hintElement.textContent = originalHintText;
									}, 1500);
								}
							} catch (fallbackErr) {
								console.error('降级复制也失败:', fallbackErr);
							}
							
							document.body.removeChild(textArea);
						}
					});
				});
				
				const headings = document.querySelectorAll('.prose h2, .prose h3');
				headings.forEach((heading) => {
					if (!heading.id) {
						const text = heading.textContent || '';
						heading.id = generateSlug(text);
					}
				});

				// 平滑滚动
				const tocLinks = document.querySelectorAll('.toc-link');
				tocLinks.forEach((link) => {
					link.addEventListener('click', (e) => {
						e.preventDefault();
						const targetId = link.getAttribute('href')?.slice(1) || '';
						const targetElement = document.getElementById(targetId);
						if (targetElement) {
							const headerOffset = 80;
							const elementPosition = targetElement.getBoundingClientRect().top;
							const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
							
							window.scrollTo({
								top: offsetPosition,
								behavior: 'smooth'
							});
							// 更新 URL 但不触发滚动
							window.history.pushState(null, '', `#${targetId}`);
						}
					});
				});

				// 高亮当前阅读位置
				const updateActiveTocLink = () => {
					const headings = document.querySelectorAll('.prose h2, .prose h3');
					const tocLinks = document.querySelectorAll('.toc-link');
					
					let current = '';
					const scrollPosition = window.scrollY + 200; // 提前触发距离
					
					headings.forEach((heading) => {
						const headingTop = heading.getBoundingClientRect().top + window.pageYOffset;
						if (scrollPosition >= headingTop) {
							current = heading.id;
						}
					});

					tocLinks.forEach((link) => {
						const slug = link.getAttribute('data-slug');
						if (slug === current) {
							link.classList.add('active');
						} else {
							link.classList.remove('active');
						}
					});
				};

				// 回到顶部按钮
				const backToTopButton = document.getElementById('back-to-top');
				const scrollThreshold = 300;
				
				function toggleBackToTop() {
					if (window.scrollY > scrollThreshold) {
						backToTopButton?.classList.add('visible');
					} else {
						backToTopButton?.classList.remove('visible');
					}
				}
				
				// 使用 throttle 优化滚动性能（合并多个滚动处理）
				let ticking = false;
				window.addEventListener('scroll', () => {
					if (!ticking) {
						window.requestAnimationFrame(() => {
							updateActiveTocLink();
							toggleBackToTop();
							ticking = false;
						});
						ticking = true;
					}
				});
				
				// 初始调用
				updateActiveTocLink();
				toggleBackToTop();
				
				// 点击回到顶部
				backToTopButton?.addEventListener('click', () => {
					window.scrollTo({
						top: 0,
						behavior: 'smooth'
					});
				});
			});
		</script>
	</body>
</html>
