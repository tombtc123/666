---
import type { CollectionEntry, MarkdownHeading } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';

type Props = CollectionEntry<'blog'>['data'] & {
	headings?: MarkdownHeading[];
};

const { title, description, headings = [] } = Astro.props;
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			html,
			body {
				max-width: 100%;
				overflow-x: hidden;
				position: relative;
				width: 100%;
			}
			
			/* 固定导航栏 */
			.blog-nav-bar {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				z-index: 1000;
				background-color: rgba(255, 255, 255, 0.9);
				backdrop-filter: blur(10px);
				-webkit-backdrop-filter: blur(10px);
				border-bottom: 1px solid rgba(0, 0, 0, 0.05);
				box-sizing: border-box;
			}
			
			html.dark .blog-nav-bar {
				background-color: rgba(26, 26, 26, 0.9);
				border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			}
			
			.blog-nav-container {
				position: relative;
				display: flex;
				align-items: center;
				justify-content: space-between;
				padding: 20px 1.5rem;
				max-width: 100%;
				box-sizing: border-box;
			}
			
			/* 左侧"回到主页"按钮（桌面端隐藏） */
			.blog-home-link-left {
				display: none;
			}
			
			/* Logo - 桌面端在左侧，移动端居中 */
			.blog-logo {
				position: absolute;
				left: 1.5rem;
				font-size: 1.8rem;
				font-weight: 800;
				font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
				letter-spacing: -0.02em;
				white-space: nowrap;
				text-decoration: none;
				transition: opacity 0.2s ease;
			}
			
			.blog-logo:hover {
				opacity: 0.8;
			}
			
			/* 12580 部分 - 蓝色渐变 */
			.logo-part-12580 {
				background: linear-gradient(135deg, #2563eb, #3b82f6);
				-webkit-background-clip: text;
				background-clip: text;
				-webkit-text-fill-color: transparent;
				color: transparent;
			}
			
			/* 123 部分 - 紫色渐变 */
			.logo-part-123 {
				background: linear-gradient(135deg, #9333ea, #a855f7);
				-webkit-background-clip: text;
				background-clip: text;
				-webkit-text-fill-color: transparent;
				color: transparent;
			}
			
			/* .com 部分 - 使用 123 的颜色 */
			.logo-part-com {
				background: linear-gradient(135deg, #9333ea, #a855f7);
				-webkit-background-clip: text;
				background-clip: text;
				-webkit-text-fill-color: transparent;
				color: transparent;
			}
			
			/* "回到主页"按钮（桌面端在右侧） */
			.blog-home-link {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				height: 36px;
				padding: 0 12px;
				border-radius: 999px;
				border: 1px solid rgba(0, 0, 0, 0.08);
				background: rgba(255, 255, 255, 0.6);
				color: var(--text-color);
				opacity: 0.9;
				transition: background-color 0.2s ease, transform 0.2s ease, opacity 0.2s ease, border-color 0.2s ease;
				text-decoration: none;
				font-size: 13px;
				letter-spacing: 0.2px;
				white-space: nowrap;
			}
			
			/* 桌面端：右侧按钮组 */
			.blog-nav-actions {
				position: absolute;
				right: 1.5rem;
				display: flex;
				align-items: center;
				gap: 0.75rem;
			}
			
			.blog-home-link:hover {
				background-color: rgba(0, 0, 0, 0.05);
				opacity: 1;
				transform: translateY(-1px);
			}
			
			html.dark .blog-home-link {
				border-color: rgba(255, 255, 255, 0.16);
				background: rgba(26, 26, 26, 0.6);
			}

			html.dark .blog-home-link:hover {
				background-color: rgba(255, 255, 255, 0.1);
			}
			
			.blog-home-link:active {
				transform: translateY(0);
			}
			
			/* 暗黑模式切换按钮（桌面端） */
			.blog-dark-mode-toggle {
				width: 36px;
				height: 36px;
				padding: 0;
				border: none;
				background: transparent;
				cursor: pointer;
				border-radius: 50%;
				color: var(--text-color);
				display: flex;
				align-items: center;
				justify-content: center;
				transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
				opacity: 0.8;
			}
			
			/* 移动端暗黑模式按钮（默认隐藏） */
			.blog-dark-mode-toggle-mobile {
				display: none;
			}
			
			.blog-dark-mode-toggle:hover {
				background-color: rgba(0, 0, 0, 0.05);
				opacity: 1;
				transform: scale(1.1);
			}
			
			html.dark .blog-dark-mode-toggle:hover {
				background-color: rgba(255, 255, 255, 0.1);
			}
			
			.blog-dark-mode-toggle:active {
				transform: scale(0.95);
			}
			
			.blog-icon {
				width: 20px;
				height: 20px;
				stroke-width: 2;
			}
			
			@media (max-width: 768px) {
				.blog-nav-container {
					padding: 18px 1rem;
					justify-content: space-between;
				}
				
				/* 移动端：左侧显示"回到主页"按钮 */
				.blog-home-link-left {
					display: inline-flex;
					position: absolute;
					left: 1rem;
					height: 32px;
					padding: 0 10px;
					font-size: 11px;
					line-height: 1;
				}
				
				/* 移动端：Logo 居中 */
				.blog-logo {
					left: 50%;
					transform: translateX(-50%);
					font-size: 0.9rem;
					white-space: nowrap;
				}
				
				/* 移动端：显示移动端暗黑模式按钮，隐藏桌面端按钮组 */
				.blog-nav-actions {
					display: none;
				}
				
				.blog-dark-mode-toggle-mobile {
					display: flex;
					position: absolute;
					right: 1rem;
					width: 32px;
					height: 32px;
					padding: 0;
					border: none;
					background: transparent;
					cursor: pointer;
					border-radius: 50%;
					color: var(--text-color);
					align-items: center;
					justify-content: center;
					transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
					opacity: 0.8;
				}
				
				.blog-dark-mode-toggle-mobile:hover {
					background-color: rgba(0, 0, 0, 0.05);
					opacity: 1;
					transform: scale(1.1);
				}
				
				html.dark .blog-dark-mode-toggle-mobile:hover {
					background-color: rgba(255, 255, 255, 0.1);
				}
				
				.blog-icon {
					width: 16px;
					height: 16px;
				}
			}
			
			/* 更小屏幕的优化 */
			@media (max-width: 480px) {
				.blog-nav-container {
					padding: 16px 0.75rem;
				}
				
				.blog-home-link-left {
					left: 0.75rem;
					height: 30px;
					padding: 0 8px;
					font-size: 10px;
				}
				
				.blog-logo {
					font-size: 0.8rem;
				}
				
				.blog-dark-mode-toggle-mobile {
					right: 0.75rem;
					width: 30px;
					height: 30px;
				}
				
				.blog-icon {
					width: 15px;
					height: 15px;
				}
			}
			
			main {
				width: calc(100% - 2em);
				max-width: 100%;
				margin: 0;
				padding-top: 80px;
				box-sizing: border-box;
				overflow-x: hidden;
			}
			.article-container {
				display: flex;
				max-width: 1200px;
				margin: 0 auto;
				gap: 2rem;
				align-items: flex-start;
				width: 100%;
				box-sizing: border-box;
				overflow-x: hidden;
			}
			.prose {
				flex: 1;
				width: 680px;
				max-width: 100%;
				margin: 0 auto;
				padding: 1em;
				/* 字体、字号、行高、颜色等排版样式已在 global.css 中定义 */
			}
			
			@media (max-width: 768px) {
				.prose {
					padding-left: 1rem;
					padding-right: 1rem;
				}
			}
			.toc {
				position: sticky;
				top: 2rem;
				width: 200px;
				max-height: calc(100vh - 4rem);
				overflow-y: auto;
				padding: 1rem 0;
				font-size: 0.875rem;
				line-height: 1.6;
			}
			.toc-title {
				font-size: 0.75rem;
				font-weight: 600;
				color: #888;
				text-transform: uppercase;
				letter-spacing: 0.05em;
				margin-bottom: 0.75rem;
				transition: color 0.2s ease;
			}
			
			html.dark .toc-title {
				color: #aaaaaa;
			}
			.toc-list {
				list-style: none;
				padding: 0;
				margin: 0;
			}
			.toc-item {
				margin-bottom: 0.5rem;
			}
			.toc-link {
				color: #888;
				text-decoration: none;
				display: block;
				transition: color 0.2s;
			}
			
			html.dark .toc-link {
				color: #aaaaaa;
			}
			
			.toc-link:hover {
				color: var(--text-color);
			}
			
			.toc-link.active {
				color: var(--text-color);
				font-weight: 500;
			}
			.toc-item-h3 {
				padding-left: 1rem;
			}
			.prose :global(h2),
			.prose :global(h3) {
				scroll-margin-top: 2rem;
			}
			@media (max-width: 1024px) {
				.toc {
					display: none;
				}
				.article-container {
					flex-direction: column;
					padding: 0 1rem;
					width: 100%;
					box-sizing: border-box;
					overflow-x: hidden;
				}
				.prose {
					width: 100%;
					max-width: 100%;
					padding-left: 1rem;
					padding-right: 1rem;
				}
			}
			
			/* 回到顶部按钮 */
			.back-to-top {
				position: fixed;
				bottom: 2rem;
				right: 1.5rem;
				width: 48px;
				height: 48px;
				border-radius: 50%;
				background-color: #6366f1;
				color: #ffffff;
				border: none;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
				opacity: 0;
				pointer-events: none;
				transition: opacity 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
				z-index: 40;
			}
			
			.back-to-top.visible {
				opacity: 1;
				pointer-events: auto;
			}
			
			.back-to-top:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 16px rgba(99, 102, 241, 0.5);
			}
			
			.back-to-top:active {
				transform: translateY(0);
			}
			
			.back-to-top-icon {
				width: 24px;
				height: 24px;
			}
			
			@media (max-width: 768px) {
				.back-to-top {
					bottom: 1.5rem;
					right: 1rem;
					width: 44px;
					height: 44px;
				}
				
				.back-to-top-icon {
					width: 20px;
					height: 20px;
				}
			}
			
			/* 内联复制代码样式 */
			.copy-code-inline {
				display: inline-block;
				background-color: #f3f4f6;
				padding: 4px 8px;
				border-radius: 4px;
				font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Courier New', monospace;
				font-weight: 600;
				font-size: 0.9em;
				color: #1f2937;
				cursor: pointer;
				user-select: all;
				-webkit-user-select: all;
				transition: background-color 0.2s ease, color 0.2s ease;
				position: relative;
			}
			
			.copy-code-inline:hover {
				background-color: #e5e7eb;
			}
			
			html.dark .copy-code-inline {
				background-color: rgba(255, 255, 255, 0.1);
				color: #e5e7eb;
			}
			
			html.dark .copy-code-inline:hover {
				background-color: rgba(255, 255, 255, 0.15);
			}
			
			.copy-code-inline.copied {
				background-color: rgba(16, 185, 129, 0.15);
				color: #10b981;
			}
			
			html.dark .copy-code-inline.copied {
				background-color: rgba(52, 211, 153, 0.2);
				color: #34d399;
			}
			
			/* 复制提示文字 */
			.copy-hint {
				font-size: 0.85em;
				color: #6b7280;
				margin-left: 6px;
				font-style: italic;
				cursor: pointer;
				transition: color 0.2s ease;
			}
			
			.copy-hint:hover {
				color: #374151;
			}
			
			html.dark .copy-hint {
				color: #9ca3af;
			}
			
			html.dark .copy-hint:hover {
				color: #d1d5db;
			}
			
			.copy-hint.copied-hint {
				color: #10b981;
			}
			
			html.dark .copy-hint.copied-hint {
				color: #34d399;
			}
			
			/* 外部链接样式 */
			.external-link {
				color: #2563eb;
				text-decoration: underline;
				text-decoration-color: rgba(37, 99, 235, 0.3);
				text-underline-offset: 2px;
				transition: text-decoration-color 0.2s ease, color 0.2s ease;
				cursor: pointer;
			}
			
			.external-link:hover {
				color: #1d4ed8;
				text-decoration-color: #2563eb;
			}
			
			html.dark .external-link {
				color: #60a5fa;
				text-decoration-color: rgba(96, 165, 250, 0.3);
			}
			
			html.dark .external-link:hover {
				color: #93c5fd;
				text-decoration-color: #60a5fa;
			}
		</style>
	</head>

	<body>
		<!-- 固定导航栏 -->
		<nav class="blog-nav-bar">
			<div class="blog-nav-container">
				<!-- 移动端：左侧"回到主页"按钮 -->
				<a href="/" class="blog-home-link blog-home-link-left">回到主页</a>
				<!-- 桌面端：右侧按钮组 -->
				<div class="blog-nav-actions">
					<a href="/" class="blog-home-link">回到主页</a>
					<button id="blog-dark-mode-toggle" class="blog-dark-mode-toggle" aria-label="Toggle dark mode">
						<svg class="blog-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
						</svg>
					</button>
				</div>
				<!-- Logo -->
				<a href="/" class="blog-logo">
					<span class="logo-part-12580">12580</span>
					<span class="logo-part-123">123</span>
					<span class="logo-part-com">.com</span>
				</a>
				<!-- 移动端：右侧暗黑模式按钮 -->
				<button id="blog-dark-mode-toggle-mobile" class="blog-dark-mode-toggle-mobile" aria-label="Toggle dark mode">
					<svg class="blog-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
					</svg>
				</button>
			</div>
		</nav>
		
		<main>
			<article>
				<div class="article-container">
					<div class="prose">
						<slot />
					</div>
					{headings.length > 0 && (
						<nav class="toc" id="toc">
							<div class="toc-title">目录</div>
							<ul class="toc-list">
								{headings.map((heading) => {
									// 使用 heading.slug（如果存在），否则生成一个
									const slug = heading.slug || heading.text.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').trim();
									return (
										<li class={`toc-item ${heading.depth === 3 ? 'toc-item-h3' : ''}`}>
											<a href={`#${slug}`} class="toc-link" data-slug={slug}>
												{heading.text}
											</a>
										</li>
									);
								})}
							</ul>
						</nav>
					)}
				</div>
			</article>
		</main>
		<Footer />
		<button id="back-to-top" class="back-to-top" aria-label="Back to top">
			<svg class="back-to-top-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="m18 15-6-6-6 6"></path>
			</svg>
		</button>
		<script>
			// 暗黑模式切换功能
			function initBlogDarkMode() {
				const toggleButton = document.getElementById('blog-dark-mode-toggle');
				const toggleButtonMobile = document.getElementById('blog-dark-mode-toggle-mobile');
				const html = document.documentElement;
				
				// 设置主题
				function setTheme(theme) {
					if (theme === 'dark') {
						html.classList.add('dark');
						try {
							localStorage.setItem('theme', 'dark');
						} catch (e) {
							// 忽略 localStorage 错误
						}
					} else {
						html.classList.remove('dark');
						try {
							localStorage.setItem('theme', 'light');
						} catch (e) {
							// 忽略 localStorage 错误
						}
					}
				}
				
				// 切换主题
				function toggleTheme() {
					const isDark = html.classList.contains('dark');
					setTheme(isDark ? 'light' : 'dark');
				}
				
				// 绑定点击事件（桌面端和移动端）
				if (toggleButton) {
					toggleButton.addEventListener('click', toggleTheme);
				}
				if (toggleButtonMobile) {
					toggleButtonMobile.addEventListener('click', toggleTheme);
				}
				
				// 监听系统主题变化（仅当用户没有手动设置主题时）
				if (window.matchMedia) {
					window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
						try {
							if (!localStorage.getItem('theme')) {
								setTheme(e.matches ? 'dark' : 'light');
							}
						} catch (e) {
							// 忽略 localStorage 错误
						}
					});
				}
			}
			
			// DOM 加载完成后初始化暗黑模式
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initBlogDarkMode);
			} else {
				initBlogDarkMode();
			}
			
			// 生成 slug（与 Astro 默认行为一致）
			function generateSlug(text) {
				return text
					.toLowerCase()
					.replace(/[^\w\s-]/g, '')
					.replace(/\s+/g, '-')
					.replace(/-+/g, '-')
					.trim();
			}

			// 为标题添加 ID（如果还没有）
			document.addEventListener('DOMContentLoaded', () => {
				// 内联复制代码功能
				const copyCodeElements = document.querySelectorAll('.copy-code-inline, .copy-hint');
				copyCodeElements.forEach((element) => {
					element.addEventListener('click', async () => {
						const code = element.getAttribute('data-code');
						if (!code) return;
						
						// 找到对应的推荐码元素和提示元素
						const codeElement = element.classList.contains('copy-code-inline') 
							? element 
							: element.previousElementSibling;
						const hintElement = element.classList.contains('copy-hint')
							? element
							: element.nextElementSibling;
						
						try {
							await navigator.clipboard.writeText(code);
							
							// 更新推荐码样式
							if (codeElement && codeElement.classList.contains('copy-code-inline')) {
								codeElement.classList.add('copied');
								const originalCodeText = codeElement.textContent.replace(' ✓', '');
								codeElement.textContent = originalCodeText + ' ✓';
								
								// 1.5秒后恢复
								setTimeout(() => {
									codeElement.classList.remove('copied');
									codeElement.textContent = originalCodeText;
								}, 1500);
							}
							
							// 更新提示文字样式 - 显示"复制成功"
							if (hintElement && hintElement.classList.contains('copy-hint')) {
								hintElement.classList.add('copied-hint');
								const originalHintText = hintElement.textContent;
								// 将"（点击复制）"改为"（复制成功）"
								hintElement.textContent = originalHintText.replace('点击复制', '复制成功');
								
								setTimeout(() => {
									hintElement.classList.remove('copied-hint');
									hintElement.textContent = originalHintText;
								}, 1500);
							}
						} catch (err) {
							console.error('复制失败:', err);
							// 降级方案
							const textArea = document.createElement('textarea');
							textArea.value = code;
							textArea.style.position = 'fixed';
							textArea.style.opacity = '0';
							document.body.appendChild(textArea);
							textArea.select();
							
							try {
								document.execCommand('copy');
								
								if (codeElement && codeElement.classList.contains('copy-code-inline')) {
									codeElement.classList.add('copied');
									const originalCodeText = codeElement.textContent.replace(' ✓', '');
									codeElement.textContent = originalCodeText + ' ✓';
									
									setTimeout(() => {
										codeElement.classList.remove('copied');
										codeElement.textContent = originalCodeText;
									}, 1500);
								}
								
								if (hintElement && hintElement.classList.contains('copy-hint')) {
									hintElement.classList.add('copied-hint');
									const originalHintText = hintElement.textContent;
									// 将"（点击复制）"改为"（复制成功）"
									hintElement.textContent = originalHintText.replace('点击复制', '复制成功');
									
									setTimeout(() => {
										hintElement.classList.remove('copied-hint');
										hintElement.textContent = originalHintText;
									}, 1500);
								}
							} catch (fallbackErr) {
								console.error('降级复制也失败:', fallbackErr);
							}
							
							document.body.removeChild(textArea);
						}
					});
				});
				
				const headings = document.querySelectorAll('.prose h2, .prose h3');
				headings.forEach((heading) => {
					if (!heading.id) {
						const text = heading.textContent || '';
						heading.id = generateSlug(text);
					}
				});

				// 平滑滚动
				const tocLinks = document.querySelectorAll('.toc-link');
				tocLinks.forEach((link) => {
					link.addEventListener('click', (e) => {
						e.preventDefault();
						const targetId = link.getAttribute('href')?.slice(1) || '';
						const targetElement = document.getElementById(targetId);
						if (targetElement) {
							const headerOffset = 80;
							const elementPosition = targetElement.getBoundingClientRect().top;
							const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
							
							window.scrollTo({
								top: offsetPosition,
								behavior: 'smooth'
							});
							// 更新 URL 但不触发滚动
							window.history.pushState(null, '', `#${targetId}`);
						}
					});
				});

				// 高亮当前阅读位置
				const updateActiveTocLink = () => {
					const headings = document.querySelectorAll('.prose h2, .prose h3');
					const tocLinks = document.querySelectorAll('.toc-link');
					
					let current = '';
					const scrollPosition = window.scrollY + 200; // 提前触发距离
					
					headings.forEach((heading) => {
						const headingTop = heading.getBoundingClientRect().top + window.pageYOffset;
						if (scrollPosition >= headingTop) {
							current = heading.id;
						}
					});

					tocLinks.forEach((link) => {
						const slug = link.getAttribute('data-slug');
						if (slug === current) {
							link.classList.add('active');
						} else {
							link.classList.remove('active');
						}
					});
				};

				// 回到顶部按钮
				const backToTopButton = document.getElementById('back-to-top');
				const scrollThreshold = 300;
				
				function toggleBackToTop() {
					if (window.scrollY > scrollThreshold) {
						backToTopButton?.classList.add('visible');
					} else {
						backToTopButton?.classList.remove('visible');
					}
				}
				
				// 使用 throttle 优化滚动性能（合并多个滚动处理）
				let ticking = false;
				window.addEventListener('scroll', () => {
					if (!ticking) {
						window.requestAnimationFrame(() => {
							updateActiveTocLink();
							toggleBackToTop();
							ticking = false;
						});
						ticking = true;
					}
				});
				
				// 初始调用
				updateActiveTocLink();
				toggleBackToTop();
				
				// 点击回到顶部
				backToTopButton?.addEventListener('click', () => {
					window.scrollTo({
						top: 0,
						behavior: 'smooth'
					});
				});
				
				// 自动为所有外部链接添加 target="_blank"
				const currentHost = window.location.hostname;
				const links = document.querySelectorAll('a[href]');
				
				links.forEach((link) => {
					const href = link.getAttribute('href');
					if (!href) return;
					
					// 跳过锚点链接和已经设置了 target 的链接
					if (href.startsWith('#') || link.hasAttribute('target')) return;
					
					try {
						const url = new URL(href, window.location.origin);
						// 如果是外部链接（域名不同），添加 target="_blank"
						if (url.hostname !== currentHost && url.hostname !== '') {
							link.setAttribute('target', '_blank');
							link.setAttribute('rel', 'noopener noreferrer');
						}
					} catch (e) {
						// 如果 URL 解析失败，可能是相对路径，跳过
						// 但如果是 http:// 或 https:// 开头的绝对路径，也添加 target="_blank"
						if (href.startsWith('http://') || href.startsWith('https://')) {
							link.setAttribute('target', '_blank');
							link.setAttribute('rel', 'noopener noreferrer');
						}
					}
				});
			});
		</script>
	</body>
</html>
